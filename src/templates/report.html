<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gold Pre-market Plan</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif; margin: 24px; color:#111; }
    .meta { color:#555; font-size:14px; margin-bottom: 10px; }
    h1 { margin: 0 0 8px; }
    h2 { margin-top: 22px; border-bottom:1px solid #eee; padding-bottom:8px; }
    .tl { display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700; }
    .GREEN { background:#e8f7ee; color:#137333; }
    .RED { background:#fce8e6; color:#a50e0e; }
    .NEUTRAL { background:#f1f3f4; color:#3c4043; }
    .card { border:1px solid #eee; border-radius:12px; padding:14px; margin:10px 0; }
    table { border-collapse: collapse; width:100%; }
    th,td { border-bottom:1px solid #eee; text-align:left; padding:8px; font-size:14px; vertical-align:top; }
    th { background:#fafafa; }
    .small { font-size:12px; color:#666; }
    ul { margin: 8px 0 0 18px; }
    code { background:#f6f8fa; padding:2px 6px; border-radius:6px; }
    a { color:#0969da; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <!-- 用于确认你替换的模板已生效：如果页面上能看到这一行，就说明 Actions 用到了新模板 -->
  <div class="small mono">TEMPLATE_VERSION: v4-auto-json</div>

  <h1>Gold Pre-market Plan</h1>

  <div class="meta">
    <div>SYMBOL: <b class="mono" id="symbol">--</b></div>
    <div>DATE: <b class="mono" id="date">--</b></div>
    <div>UPDATED: <b class="mono" id="updated">--</b></div>
  </div>

  <div class="card small" id="load-error" style="display:none;"></div>

  <h2>总体状态（红绿灯）
    <span class="tl NEUTRAL" id="traffic-light">NEUTRAL</span>
  </h2>

  <div class="card">
    <b>核心判断：</b> <span id="summary">--</span>
    <div class="small" style="margin-top:6px;">
      依据：趋势（MA20/MA50）、动量（RSI/MACD）、波动（ATR）与新闻情绪（粗略）。
    </div>
  </div>

  <h2>关键结论摘要</h2>
  <div class="card">
    <ul id="bullets"></ul>
  </div>

  <div class="grid">
    <div>
      <h2>盘前计划 Base Case</h2>
      <div class="card" style="white-space:pre-line;" id="base-case"></div>
    </div>
    <div>
      <h2>Alternate Case</h2>
      <div class="card" style="white-space:pre-line;" id="alt-case"></div>
    </div>
  </div>

  <h2>Watchlist</h2>
  <div class="card">
    <ul id="watchlist"></ul>
  </div>

  <h2>Execution Rules</h2>
  <div class="card">
    <ul id="rules"></ul>
  </div>

  <h2>最新行情（最近30天）</h2>
  <table>
    <thead>
      <tr>
        <th>Date</th><th>Open</th><th>High</th><th>Low</th><th>Close</th><th>Volume</th>
      </tr>
    </thead>
    <tbody id="last30"></tbody>
  </table>

  <h2>关键驱动因素</h2>
  <table>
    <thead><tr><th>Driver</th><th>Signal</th><th>Note</th></tr></thead>
    <tbody id="drivers"></tbody>
  </table>

  <h2>风险与应对</h2>
  <table>
    <thead><tr><th>Risk</th><th>Mitigation / Hedge</th></tr></thead>
    <tbody id="risks"></tbody>
  </table>

  <h2>新闻（近24–72小时）</h2>
  <div class="card" id="news"></div>

  <h2>数据来源与声明</h2>
  <div class="card">
    行情数据：<code>yfinance</code>（Yahoo Finance）或兜底源（如 Stooq）。新闻：RSS 或 NewsAPI。<br/>
    本页面为研究用途，不构成投资建议。请自行评估风险。
  </div>

  <h2>Debug</h2>
  <div class="card small">
    <div>gold_data.json: <code>gold_data.json</code></div>
    <div id="debug-fields"></div>
  </div>

  <script>
    (() => {
      const DATA_URL = 'gold_data.json';

      const escapeHtml = (value) => String(value)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');

      const setText = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = value == null ? '' : String(value);
        }
      };

      const renderList = (id, items, emptyMessage) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!Array.isArray(items) || items.length === 0) {
          el.innerHTML = `<li class="small">${escapeHtml(emptyMessage)}</li>`;
          return;
        }
        el.innerHTML = items.map((item) => `<li>${escapeHtml(item)}</li>`).join('');
      };

      const renderTable = (id, rows, columns) => {
        const el = document.getElementById(id);
        if (!el) return;
        if (!Array.isArray(rows) || rows.length === 0) {
          el.innerHTML = `<tr><td colspan="${columns.length}" class="small">暂无数据</td></tr>`;
          return;
        }
        el.innerHTML = rows.map((row) => {
          const cells = columns.map((column) => {
            const value = row && row[column.key] != null ? row[column.key] : '';
            const content = column.bold ? `<b>${escapeHtml(value)}</b>` : escapeHtml(value);
            const classAttr = column.className ? ` class="${column.className}"` : '';
            return `<td${classAttr}>${content}</td>`;
          }).join('');
          return `<tr>${cells}</tr>`;
        }).join('');
      };

      const renderNews = (news) => {
        const el = document.getElementById('news');
        if (!el) return;
        if (!Array.isArray(news) || news.length === 0) {
          el.innerHTML = '<div class="small">暂无可用新闻源（RSS/NewsAPI 可能暂时不可用）。</div>';
          return;
        }
        el.innerHTML = `<ul>${news.map((item) => {
          const title = escapeHtml(item?.title || '');
          const url = item?.url ? escapeHtml(item.url) : '';
          const source = escapeHtml(item?.source || '');
          const published = escapeHtml(item?.published || '');
          const summary = item?.summary ? `<div class="small" style="margin-top:4px;">${escapeHtml(item.summary)}</div>` : '';
          const metaParts = [source, published].filter(Boolean);
          const meta = metaParts.length ? ` <span class="small">（${metaParts.join(' · ')}）</span>` : '';
          const titleHtml = url ? `<a href="${url}" target="_blank" rel="noreferrer">${title}</a>` : title;
          return `<li style="margin-bottom:10px;">${titleHtml}${meta}${summary}</li>`;
        }).join('')}</ul>`;
      };

      const renderDebug = (debug) => {
        const el = document.getElementById('debug-fields');
        if (!el) return;
        if (!debug || typeof debug !== 'object') {
          el.innerHTML = '<div class="small">暂无调试信息。</div>';
          return;
        }
        const rows = [];
        if (debug.price_source != null) {
          rows.push(`<div>price_source: <code>${escapeHtml(debug.price_source)}</code></div>`);
        }
        if (debug.news_score != null) {
          rows.push(`<div>news_score: <code>${escapeHtml(debug.news_score)}</code></div>`);
        }
        if (debug.rows != null) {
          rows.push(`<div>rows: <code>${escapeHtml(debug.rows)}</code></div>`);
        }
        el.innerHTML = rows.join('') || '<div class="small">暂无调试信息。</div>';
      };

      const showError = (message) => {
        const errorEl = document.getElementById('load-error');
        if (!errorEl) return;
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      };

      const loadData = async () => {
        try {
          const response = await fetch(DATA_URL, { cache: 'no-store' });
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          const data = await response.json();

          setText('symbol', data.symbol || '--');
          setText('date', data.date || '--');
          setText('updated', data.updated || '--');
          setText('summary', data.summary || '--');
          setText('base-case', data.base_case || '');
          setText('alt-case', data.alt_case || '');

          const traffic = data.traffic_light || 'NEUTRAL';
          const trafficEl = document.getElementById('traffic-light');
          if (trafficEl) {
            trafficEl.textContent = traffic;
            trafficEl.className = `tl ${traffic}`;
          }

          renderList('bullets', data.bullets, '暂无摘要。');
          renderList('watchlist', data.watchlist, '暂无关注项。');
          renderList('rules', data.rules, '暂无执行规则。');

          renderTable('last30', data.last30, [
            { key: 'Date', className: 'mono' },
            { key: 'Open' },
            { key: 'High' },
            { key: 'Low' },
            { key: 'Close', bold: true },
            { key: 'Volume' }
          ]);

          renderTable('drivers', data.drivers, [
            { key: 'driver' },
            { key: 'signal', bold: true },
            { key: 'note' }
          ]);

          renderTable('risks', data.risks, [
            { key: 'risk' },
            { key: 'hedge' }
          ]);

          renderNews(data.news);
          renderDebug(data.debug);
        } catch (error) {
          console.error('Failed to load gold_data.json', error);
          showError('gold_data.json 加载失败，请稍后刷新重试。');
        }
      };

      loadData();
    })();
  </script>
</body>
</html>
